---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r}
diamonds <- read.delim("HW-diamonds.txt", header = FALSE, sep = "", dec = ".")
```

```{r}
head(diamonds)
```


```{r}
colnames(diamonds) <- c("caratage", "purity", "clarity", "certificate", "price")
diamonds$purity <- factor(diamonds$purity, levels=c("D", "E", "F", "G", "H", "I"))
diamonds$clarity <- factor(diamonds$clarity, levels=c("VS2", "VS1", "VVS2", "VVS1", "IF"))
```

```{r}
summary(diamonds)
```

```{r}
library(ggplot2)
```

### 1. Plot price vs caratage and log(price) vs caratage. Decide on which response variable is better to use

```{r}
ggplot(data=diamonds, aes(price, caratage)) + 
        geom_point()
ggplot(data=diamonds, aes(log(price), caratage)) + 
        geom_point()
```

log(price) seems more linear (maybe different transformations?)

### 2. Find a suitable way to include, besides caratage, the other categorical information
available: clarity, color and certificate. Use the worst level of each categorical variable
as the reference category and HRD for certification institution. Comment on the model
fitted, and perform a basic analysis of the residuals (normality, constant variance,
independence, you may also want to use the function outlierTest or residualPlot ).
```{r}
#Starting model
model.1.1<-lm(formula = price ~ caratage + purity + clarity + certificate, data = diamonds)
summary(model.1.1)

#Let's try to predict log(price)
model.1.2<-lm(formula = log(price) ~ caratage + purity + clarity + certificate, data = diamonds)
summary(model.1.2)
#model1.2 has a lower residual standard error and a higher R^2. We will predict log(price).

#By default, the category that R chooses to be the reference or baseline, is the first category that appears alphabetically or  numerically (if categories are coded using 0,1,2,...).
#Let's use the worst level of each categorical variable as the reference category and HRD for certification institution.
diamonds$purity <- relevel(diamonds$purity, ref = "I")
diamonds$clarity <- relevel(diamonds$clarity, ref = "VS2")
diamonds$certificate <- relevel(diamonds$certificate, ref = "HRD")
model.1.3<-lm(formula = log(price) ~ caratage + purity + clarity + certificate, data = diamonds)
summary(model.1.3)
#Same statistics as model1.2.

#Let's check the interactions.
model.1.4 <- lm(formula = log(price) ~ .^2, data = diamonds)
summary(model.1.4)
#The standard error decreases  and th R^2 increases. However, only some interactions are relevant. Let's keep only those.

model.1.5 <- lm(formula = log(price) ~ caratage + purity + clarity + certificate + caratage:purity + caratage:clarity + caratage:certificate, data = diamonds)
summary(model.1.5)
#model.1.5 shows slightly worse statistics than model.1.4 but is way simpler.

#Let's analyse this model deeper.
# Residuals vs Fitted Plot
residuals_vs_fitted<-plot(model.1.5, which=1, col=c("blue"))
#Normal Q-Q Plot
qq_plot<-plot(model.1.5, which=2, col=c("blue")) 
#Scale-Location
residuals_vs_fitted<-plot(model.1.5, which=3, col=c("blue"))
#Residuals vs Leverage
residuals_vs_fitted<-plot(model.1.5, which=5, col=c("blue")) 

```



### 3. Try two different remedial actions:

### 3a. Create a new categorical variable to segregate the stones according to caratage: let's say less than 0.5 carats small, 0.5 to less than 1 carat (medium) and 1 carat and over (large). Make small as the reference category. Add this new variable to the existing model as well as an interaction term between this new variable and caratage.


* Is this regression model satisfactory? Are the standard assumptions of linear
regression validated? Are the numerical estimates sensible?

* Interpret the interaction parameter med*carat. What can we infer on the incremental pricing of caratage in the 3 clusters?

* Which is more highly valued: colour or clarity?

* All other things being equal, what is the average price difference between a grade D diamond and another one graded (a) I (b) E?

* All other things being equal, are there price differences amongst the stones appraised by the GIA, IGI and HRD?


### 3b. Include the square of carat as a new explanatory variable. It avoids the subjectivity of clusters definition.


### 4. Which of the two remedial actions do you prefer and why? Think on terms of interpretability and validity of the assumptions.




